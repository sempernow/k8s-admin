---
apiVersion: v1
kind: Secret
metadata:
  name: smb-krb5-creds
  namespace: smb
  labels:
    cifs: ""
type: Opaque
data:
  # Either keytab or ticket cache method result in mount fail by "Invalid UTF-8"
  # Without it, mount fails by "Empty kerberos cache"
  #krb5.keytab: BQIAAABFAAEACExJTUUuTEFOAApzdmMtc21iLXJ3AAAAAQAAAAADABIAIAl6pXCO4ceURRTi0ifOs2o87jqtWEdI5cJXfDEjunCk
  #krb5cc_322203108: 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
  #username: c3ZjLXNtYi1yd0BMSU1FLkxBTg==
  #password: cWhobzdNdkpNbGtwdmVBcWpYaDZZSA==
  krb5cc_322203108: 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
  password: ""
  username: c3ZjLXNtYi1yd0BMSU1FLkxBTg==
#stringData:
  # For Kerberos, you might use these fields differently
  #username: "svc-smb-rw@LIME"  # Principal with realm
  #password: "__REDACTED__"

---
apiVersion: v1
kind: PersistentVolume
metadata:
  annotations:
    pv.kubernetes.io/provisioned-by: smb.csi.k8s.io
  name: smb-pv
  labels:
    cifs: ""
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: "" # Prevent from using StorageClass smb 
  mountOptions:
    - sec=krb5
    - vers=3.0
    - dir_mode=0775
    - file_mode=0640
    - cruid=322203108
    - uid=1000
    - gid=1000
    - noperm
    - mfsymlinks
    - cache=strict
    - noserverino  # required to prevent data corruption
  csi:
    driver: smb.csi.k8s.io
    volumeHandle: dc1.lime.lan.SMBdata
    volumeAttributes:
      source: //dc1.lime.lan/SMBdata
    nodeStageSecretRef:
      name: smb-krb5-creds
      namespace: smb

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: smb-pvc
  namespace: smb
  labels:
    cifs: ""
spec:
  storageClassName: "" # Prevent from using StorageClass smb 
  volumeName: smb-pv
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi

---
apiVersion: v1
kind: Pod
metadata:
  name: smb-pod 
  namespace: smb
  labels:
    cifs: ""
spec:
  containers:
  - name: volume-test
    image: nginx:stable-alpine
    imagePullPolicy: IfNotPresent
    volumeMounts:
    - name: vol1
      mountPath: /data
    ports:
    - containerPort: 80
    securityContext:
      runAsUser: 1001
      runAsGroup: 1001
  volumes:
  - name: vol1
    persistentVolumeClaim:
      claimName: smb-pvc
